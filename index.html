<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE COLOSSEUM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #0a0e27, #1a1a3e);
            color: #fff;
            direction: rtl;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            color: #d4af37;
            letter-spacing: 3px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .login-box {
            background: rgba(212, 175, 55, 0.1);
            border: 3px solid #d4af37;
            padding: 50px;
            border-radius: 10px;
            max-width: 500px;
            margin: 50px auto;
            text-align: center;
        }

        .login-box h2 {
            color: #d4af37;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-box input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
            text-align: center;
        }

        .login-box button {
            width: 100%;
            padding: 15px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .team-card {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .team-card h3 {
            color: #d4af37;
            margin-bottom: 15px;
        }

        .team-card p {
            margin-bottom: 10px;
        }

        .team-btn {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }

        .start-btn {
            width: 100%;
            padding: 20px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 5px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            display: none;
        }

        .start-btn.show {
            display: block;
        }

        .code-container {
            background: rgba(212, 175, 55, 0.1);
            border: 3px solid #d4af37;
            padding: 50px;
            border-radius: 10px;
            max-width: 600px;
            margin: 50px auto;
            text-align: center;
        }

        .timer {
            background: rgba(212, 175, 55, 0.2);
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 1.5em;
            font-family: monospace;
            display: none;
        }

        .timer.show {
            display: block;
        }

        .code-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #d4af37;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: #d4af37;
            text-align: center;
            text-transform: uppercase;
            font-size: 1.2em;
        }

        .message {
            margin-top: 20px;
            min-height: 30px;
        }

        .message.success {
            color: #4CAF50;
        }

        .message.error {
            color: #ff6b6b;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .image-box {
            width: 100%;
            height: 250px;
            border: 2px solid #d4af37;
            border-radius: 5px;
            overflow: hidden;
        }

        .image-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .admin-btn {
            width: 100%;
            padding: 15px;
            background: #d4af37;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ” THE COLOSSEUM</h1>
    </div>

    <div class="container">
        <!-- Login -->
        <div class="screen active" id="login">
            <div class="login-box">
                <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <input type="text" id="name" placeholder="Ø§Ø³Ù…Ùƒ">
                <button onclick="enterGame()">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="adminScreen()" style="background: #888;">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
            </div>
        </div>

        <!-- Admin Login -->
        <div class="screen" id="adminLogin">
            <div class="login-box">
                <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button onclick="checkAdmin()">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="backLogin()" style="background: #888;">Ø¹ÙˆØ¯Ø©</button>
            </div>
        </div>

        <!-- Teams -->
        <div class="screen" id="teams">
            <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
            <div class="timer show" id="timerDisplay">â±ï¸ <span id="time">02:00:00</span></div>
            <div class="teams-grid" id="teamsGrid"></div>
            <button class="start-btn" id="startBtn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</button>
        </div>

        <!-- Code -->
        <div class="screen" id="code">
            <div class="code-container">
                <h2 id="teamName">Ø§Ù„ÙØ±ÙŠÙ‚</h2>
                <div class="timer show" id="codeTimer">â±ï¸ <span id="codeTime">02:00:00</span></div>
                <input type="text" id="codeInput" class="code-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙØ±Ø©" onkeypress="if(event.key==='Enter') verify()">
                <button onclick="verify()" style="background: #d4af37; color: #000; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer;">ØªØ­Ù‚Ù‚</button>
                <div class="message" id="msg"></div>
            </div>
        </div>

        <!-- Images -->
        <div class="screen" id="images">
            <h2 style="text-align: center; color: #d4af37; margin-bottom: 30px;">Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¶ÙŠØ©</h2>
            <div class="images-grid" id="imagesGrid"></div>
            <button onclick="backTeams()" style="width: 100%; padding: 15px; background: #d4af37; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Ø¹ÙˆØ¯Ø©</button>
        </div>

        <!-- Admin -->
        <div class="screen" id="admin">
            <div class="login-box">
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
                <button class="admin-btn" onclick="showStats()">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                <button class="admin-btn" onclick="resetGame()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                <button class="admin-btn" onclick="backLogin()" style="background: #888;">Ø®Ø±ÙˆØ¬</button>
                <div id="stats" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://uidjszsqwuccjyzsatdk.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpZGpzenNxd3VjY2p5enNhdGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDQwMzcsImV4cCI6MjA4NTM4MDAzN30.AGGAiOtEas-aW2rYSuzTCT3KbwkWrhCi9xA5AyrYxaM'
        );

        const CODES = ['POWER', 'WISDOM', 'VALOR', 'PATIENCE', 'PROMTITUDE', 'FAITH', 'HONESTY', 'JUSTICE', 'INTEGRITY'];
        const IMAGES = ['https://i.imgur.com/mG1EsgX.jpg', 'https://i.imgur.com/BgxLUmr.jpg', 'https://i.imgur.com/shFAoGJ.jpg', 'https://i.imgur.com/9nQC9ay.jpg', 'https://i.imgur.com/X9vtn6w.jpg', 'https://i.imgur.com/23dKeLP.jpg', 'https://i.imgur.com/rICqT3D.jpg', 'https://i.imgur.com/3OAJguF.jpg', 'https://i.imgur.com/B3tnfms.jpg'];

        const teams = Array(9).fill(0).map((_, i) => ({id: i + 1, number: i + 1, members: [], leader: null, solved: false, attempts: 0}));

        let currentUser = null;
        let currentTeam = null;
        let gameStarted = false;
        let timeRemaining = 7200;
        let timerInterval = null;

        function show(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function enterGame() {
            const name = document.getElementById('name').value.trim();
            if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ'); return; }
            currentUser = name;
            loadData();
            show('teams');
        }

        function adminScreen() {
            show('adminLogin');
        }

        function checkAdmin() {
            if (document.getElementById('adminPass').value === 'admin123') {
                show('admin');
            } else {
                alert('Ø®Ø·Ø£');
            }
        }

        function backLogin() {
            show('login');
        }

        function backTeams() {
            show('teams');
        }

        async function loadData() {
            const { data } = await supabaseClient.from('game_state').select('*').eq('id', 1).single();
            if (data) {
                gameStarted = data.started;
                timeRemaining = data.time_remaining;
                if (data.teams) {
                    data.teams.forEach(t => {
                        const team = teams.find(x => x.id === t.id);
                        if (team) Object.assign(team, t);
                    });
                }
            }
            renderTeams();
            subscribe();
        }

        function subscribe() {
            supabaseClient.channel('updates').on('postgres_changes', {event: '*', schema: 'public', table: 'game_state'}, (p) => {
                if (p.new) {
                    gameStarted = p.new.started;
                    timeRemaining = p.new.time_remaining;
                    if (p.new.teams) p.new.teams.forEach(t => {
                        const team = teams.find(x => x.id === t.id);
                        if (team) Object.assign(team, t);
                    });
                    if (document.getElementById('teams').classList.contains('active')) renderTeams();
                }
            }).subscribe();
        }

        async function save() {
            const gameData = {started: gameStarted, time_remaining: timeRemaining, teams: teams.map(t => ({id: t.id, number: t.number, members: t.members, leader: t.leader, solved: t.solved, attempts: t.attempts}))};
            await supabaseClient.from('game_state').update(gameData).eq('id', 1);
        }

        function renderTeams() {
            let html = '';
            teams.forEach(t => {
                const isMember = t.members.includes(currentUser);
                const isFull = t.members.length >= 4 && !isMember;
                html += `<div class="team-card" style="${currentTeam?.id === t.id ? 'border-color: #ffd700; background: rgba(212, 175, 55, 0.3);' : ''}">
                    <h3>Ø§Ù„ÙØ±ÙŠÙ‚ ${t.number}</h3>
                    <p>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${t.members.length}/4</p>
                    ${t.members.length > 0 ? `<p style="color: #ffd700; font-size: 0.9em;">ğŸ‘¥ ${t.members.join(', ')}</p>` : '<p style="color: #4CAF50;">âœ… Ù…ØªØ§Ø­</p>'}
                    ${!isFull && !isMember ? `<button class="team-btn" onclick="selectTeam(${t.id})">Ø§Ø®ØªØ±</button>` : ''}
                    ${isMember ? `<button class="team-btn" style="background: #ff6b6b;" onclick="leaveTeam(${t.id})">ØºØ§Ø¯Ø±</button>` : ''}
                </div>`;
            });
            document.getElementById('teamsGrid').innerHTML = html;
        }

        function selectTeam(id) {
            const t = teams.find(x => x.id === id);
            if (t.members.length >= 4 && !t.members.includes(currentUser)) { alert('Ù…Ù…ØªÙ„Ø¦'); return; }
            if (!t.members.includes(currentUser)) {
                t.members.push(currentUser);
                if (!t.leader) t.leader = currentUser;
                save();
            }
            currentTeam = t;
            document.getElementById('startBtn').classList.add('show');
            renderTeams();
        }

        function leaveTeam(id) {
            const t = teams.find(x => x.id === id);
            t.members = t.members.filter(m => m !== currentUser);
            if (t.leader === currentUser && t.members.length > 0) t.leader = t.members[0];
            else if (t.members.length === 0) t.leader = null;
            save();
            if (currentTeam?.id === id) { currentTeam = null; document.getElementById('startBtn').classList.remove('show'); }
            renderTeams();
        }

        function startGame() {
            if (!currentTeam) { alert('Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚'); return; }
            if (!gameStarted) { gameStarted = true; save(); startTimer(); }
            document.getElementById('teamName').textContent = `Ø§Ù„ÙØ±ÙŠÙ‚ ${currentTeam.number}`;
            show('code');
            document.getElementById('code').focus();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                save();
                updateTime();
                if (timeRemaining === 300) alert('âš ï¸ 5 Ø¯Ù‚Ø§Ø¦Ù‚');
                if (timeRemaining <= 0) { clearInterval(timerInterval); alert('Ø§Ù†ØªÙ‡Ù‰'); endGame(); }
            }, 1000);
        }

        function updateTime() {
            const h = Math.floor(timeRemaining / 3600), m = Math.floor((timeRemaining % 3600) / 60), s = timeRemaining % 60;
            const t = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            document.getElementById('time').textContent = t;
            document.getElementById('codeTime').textContent = t;
        }

        function verify() {
            const input = document.getElementById('codeInput').value.trim().toUpperCase();
            if (!currentTeam) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠÙ‚');
                return;
            }
            const correct = CODES[currentTeam.id - 1];
            const msg = document.getElementById('msg');
            
            if (!input) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙØ±Ø©');
                return;
            }
            
            if (input === correct) {
                msg.textContent = 'âœ… ØµØ­ÙŠØ­!';
                msg.className = 'message success';
                currentTeam.solved = true;
                timeRemaining = Math.max(0, timeRemaining - 900);
                save();
                setTimeout(() => showImages(), 1500);
            } else {
                currentTeam.attempts++;
                msg.innerHTML = `âŒ Ø®Ø·Ø£!<br>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${currentTeam.attempts}`;
                msg.className = 'message error';
                document.getElementById('codeInput').value = '';
                save();
            }
        }

        function showImages() {
            let html = '';
            IMAGES.forEach((img, i) => {
                html += `<div class="image-box"><img src="${img}" alt="ØµÙˆØ±Ø©"></div>`;
            });
            document.getElementById('imagesGrid').innerHTML = html;
            show('images');
        }

        function endGame() {
            gameStarted = false;
            timeRemaining = 7200;
            clearInterval(timerInterval);
            backTeams();
        }

        function showStats() {
            let html = '<table style="width: 100%; color: #d4af37; border-collapse: collapse;"><tr style="border-bottom: 2px solid #d4af37;"><th style="padding: 10px;">Ø§Ù„ÙØ±ÙŠÙ‚</th><th>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</th><th>Ù…Ø­Ù„</th><th>Ù…Ø­Ø§ÙˆÙ„Ø§Øª</th></tr>';
            teams.forEach(t => {
                html += `<tr style="border-bottom: 1px solid #666;"><td style="padding: 10px;">Ø§Ù„ÙØ±ÙŠÙ‚ ${t.number}</td><td>${t.members.length}</td><td>${t.solved ? 'âœ…' : 'âŒ'}</td><td>${t.attempts}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('stats').innerHTML = html;
        }

        function resetGame() {
            if (confirm('Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†ØŸ')) {
                teams.forEach(t => { t.members = []; t.leader = null; t.solved = false; t.attempts = 0; });
                gameStarted = false;
                timeRemaining = 7200;
                save();
                alert('âœ…');
                backLogin();
            }
        }

        loadData();
    </script>
</body>
</html>
